[gd_scene load_steps=7 format=2]

[ext_resource path="res://Road.gd" type="Script" id=1]
[ext_resource path="res://icon.png" type="Texture" id=2]

[sub_resource type="Shader" id=3]

code = "shader_type particles;
//uniform float density = 0.5;
uniform float flow = 0.0;
uniform float dist = 300;



float rand_from_seed(inout uint seed) {
	int k;
	int s = int(seed);
	if (s == 0)
	s = 305420679;
	k = s / 127773;
	s = 16807 * (s - k * 127773) - 2836 * k;
	if (s < 0)
		s += 2147483647;
	seed = uint(s);
	return float(seed % uint(65536))/65535.0;
}


uint hash(uint x) {
	x = ((x >> uint(16)) ^ x) * uint(73244475);
	x = ((x >> uint(16)) ^ x) * uint(73244475);
	x = (x >> uint(16)) ^ x;
	return x;
}

void vertex() {
	//uint base_number = NUMBER/uint(trail_divisor);
	//uint alt_seed = hash(base_number+uint(1)+RANDOM_SEED);
	
	float pi = 3.14159;
	float degree_to_rad = pi / 180.0;
	
	float speed = dist / LIFETIME;
	float density = 1.0 - 0.95 * exp(-abs(flow));

	if (RESTART) {
		VELOCITY = vec3(sign(flow) * speed, 0.0, 0.0);
		VELOCITY = (EMISSION_TRANSFORM * vec4(VELOCITY,0.0)).xyz;
		TRANSFORM = EMISSION_TRANSFORM * TRANSFORM;
		TRANSFORM[3].x = -0.5 * dist * sign(flow);
		TRANSFORM[3].z = 0.0;
		if (rand_from_seed(NUMBER) > density) {
			TRANSFORM[3].z = 100.0;
		}
	} else {
	}
	
}

"

[sub_resource type="ShaderMaterial" id=4]

render_priority = 0
shader = SubResource( 3 )
shader_param/flow = null
shader_param/dist = null
_sections_unfolded = [ "Resource", "shader_param" ]

[sub_resource type="RectangleShape2D" id=5]

custom_solver_bias = 0.0
extents = Vector2( 32, 32 )

[sub_resource type="CircleShape2D" id=6]

custom_solver_bias = 0.0
radius = 10.0

[node name="Road" type="Node2D"]

script = ExtResource( 1 )
_sections_unfolded = [ "Transform" ]

[node name="Sprite" type="Sprite" parent="." index="0"]

visible = false
texture = ExtResource( 2 )

[node name="Cars" type="Particles2D" parent="." index="1"]

emitting = true
amount = 5
lifetime = 5.0
one_shot = false
preprocess = 5.0
speed_scale = 1.0
explosiveness = 0.0
randomness = 0.3
fixed_fps = 0
fract_delta = false
visibility_rect = Rect2( -100, -100, 200, 200 )
local_coords = true
draw_order = 1
process_material = SubResource( 4 )
texture = ExtResource( 2 )
normal_map = null
h_frames = 1
v_frames = 1
_sections_unfolded = [ "Drawing", "Process Material", "Time" ]

[node name="Area" type="Area2D" parent="." index="2"]

input_pickable = true
gravity_vec = Vector2( 0, 1 )
gravity = 98.0
linear_damp = 0.1
angular_damp = 1.0
audio_bus_override = false
audio_bus_name = "Master"

[node name="CollisionShape2D" type="CollisionShape2D" parent="Area" index="0"]

shape = SubResource( 5 )

[node name="Area2D" type="Area2D" parent="." index="3"]

scale = Vector2( 1, 1 )
input_pickable = true
gravity_vec = Vector2( 0, 1 )
gravity = 98.0
linear_damp = 0.1
angular_damp = 1.0
audio_bus_override = false
audio_bus_name = "Master"

[node name="Tester" type="CollisionShape2D" parent="Area2D" index="0"]

scale = Vector2( 1, 1 )
shape = SubResource( 6 )


